name: ğŸ³ Docker Build & Deploy

on:
    push:
        branches: [main]
    schedule:
        - cron: "0 0 * * *" # Daily at midnight UTC

env:
    REGISTRY: docker.io
    IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/reinvent

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v3

            - name: ğŸ”§ Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: ğŸ” Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: ğŸ“¦ Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: âœ… Image build successful
              run: echo "âœ… Docker image built and pushed successfully!"

            - name: ğŸ”„ Trigger visitor count reset
              run: |
                  echo "Triggering visitor count reset..."
                  response=$(curl -s -X POST ${{ secrets.API_URL }}/api/update-visitors \
                    -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                    -H "Content-Type: application/json" \
                    -w "\n%{http_code}")

                  http_code=$(echo "$response" | tail -n 1)
                  body=$(echo "$response" | sed '$d')

                  if [ "$http_code" = "200" ]; then
                    echo "âœ… Visitor count reset: $body"
                  else
                    echo "âŒ Failed with status $http_code: $body"
                    exit 1
                  fi

            - name: ğŸ“Š Workflow summary
              run: |
                  echo "ğŸ“Š Deployment Summary"
                  echo "===================="
                  echo "âœ… Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
                  echo "âœ… Commit: ${{ github.sha }}"
                  echo "âœ… Branch: ${{ github.ref }}"
                  echo "âœ… Timestamp: $(date)"

            - name: ğŸš¨ Notify on failure
              if: failure()
              uses: actions/github-script@v6
              with:
                  script: |
                      github.rest.repos.createCommitComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        commit_sha: context.sha,
                        body: 'âŒ Docker build or deployment failed!\n\n' +
                              'Check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
                      })
